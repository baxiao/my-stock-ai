import streamlit as st
import re
from datetime import datetime
from openai import OpenAI

# é¡µé¢åŸºæœ¬è¨­å®š
st.set_page_config(
    page_title="Aè‚¡æ–°é—»é¢AIåˆ†æ - DeepSeek",
    page_icon="ğŸ‡¨ğŸ‡³",
    layout="wide"
)

st.title("ğŸ‡¨ğŸ‡³ Aè‚¡æ–°é—»é¢åˆ©å¥½/åˆ©ç©º AI åˆ†æ")
st.caption(
    f"å½“å‰æ—¥æœŸï¼š{datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}ã€€"
    "ãƒ» åŸºäº DeepSeek æ¨¡å‹ã€€ãƒ» ä»…ä¾›å‚è€ƒï¼ŒéæŠ•èµ„å»ºè®®"
)

# â”€â”€ DeepSeek API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å¼ºçƒˆå»ºè®®ä½¿ç”¨ Streamlit Secrets ç®¡ç†ï¼Œä¸è¦æŠŠ key ç›´æ¥å†™åœ¨ä»£ç é‡Œ
DEEPSEEK_API_KEY = st.secrets.get("DEEPSEEK_API_KEY", None)

if not DEEPSEEK_API_KEY:
    st.error("å°šæœªè®¾ç½® DeepSeek API Key")
    st.markdown("""
    è¯·åœ¨ Streamlit Cloud â†’ Settings â†’ Secrets ä¸­æ–°å¢ä»¥ä¸‹å†…å®¹ï¼š
    ```
    DEEPSEEK_API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    ```
    è·å– Keyï¼šhttps://platform.deepseek.com/api_keys
    """)
    st.stop()

client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com"
)

# â”€â”€ è¾“å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
code = st.text_input(
    "è¯·è¾“å…¥Aè‚¡6ä½ä»£ç ï¼ˆä¾‹å¦‚ï¼š600519ã€300750ã€000001ï¼‰",
    value="600519",
    max_chars=6
).strip()

if not code:
    st.info("è¯·è¾“å…¥6ä½Aè‚¡ä»£ç ")
    st.stop()

if not re.match(r'^\d{6}$', code):
    st.error("è¯·è¾“å…¥æ­£ç¡®çš„6ä½çº¯æ•°å­—Aè‚¡ä»£ç ")
    st.stop()

# è‡ªåŠ¨è¡¥åç¼€
if code.startswith('6'):
    full_symbol = code + ".SS"
    exchange = "ä¸Šæµ·"
elif code.startswith(('0', '3')):
    full_symbol = code + ".SZ"
    exchange = "æ·±åœ³"
else:
    st.error("æš‚ä¸æ”¯æŒè¯¥å‰ç¼€çš„Aè‚¡ä»£ç ï¼ˆä»…æ”¯æŒ6/0/3å¼€å¤´ï¼‰")
    st.stop()

st.success(f"å·²è¯†åˆ«ï¼š{code}ã€€â†’ã€€{full_symbol}ï¼ˆ{exchange}è¯åˆ¸äº¤æ˜“æ‰€ï¼‰")

# â”€â”€ æ„å»º Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prompt_template = """ä½ æ˜¯ä¸€ä½æå…¶ä¿å®ˆã€ç»éªŒéå¸¸ä¸°å¯Œä¸”ä»ä¸å¤¸å¤§çš„ä¸­å›½Aè‚¡ä¸“ä¸šåˆ†æå¸ˆã€‚

ä»»åŠ¡ï¼šæ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œå¯¹è¯¥è‚¡ç¥¨å½“å‰çš„**æ–°é—»é¢**è¿›è¡Œå®¢è§‚ã€è°¨æ…åˆ†æã€‚

ã€è‚¡ç¥¨ä¿¡æ¯ã€‘
ä»£ç ï¼š{code}
åç§°ï¼š{name}
è¡Œä¸šï¼š{industry}

ã€è¿‘æœŸé‡è¦æ–°é—»/äº‹ä»¶æ‘˜è¦ã€‘ï¼ˆæˆªè‡³ {today}ï¼‰
{news_summary}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆç”¨ä¸­æ–‡ï¼Œç®€æ´ã€æ¡ç†æ¸…æ™°ï¼‰ï¼š

1. æ€»ä½“æ–°é—»é¢åˆ¤æ–­ï¼ˆåˆ©å¥½ / åˆ©ç©º / ä¸­æ€§ï¼‰ + å¼ºåº¦æ‰“åˆ†ï¼ˆä¾‹å¦‚ 7/10ï¼‰
2. ä¸»è¦åˆ©å¥½ç‚¹ï¼ˆåˆ—å‡º 2â€“5 æ¡ï¼Œæ¯æ¡ç®€çŸ­è¯´æ˜ï¼‰
3. ä¸»è¦åˆ©ç©º/é£é™©ç‚¹ï¼ˆåˆ—å‡º 2â€“5 æ¡ï¼Œæ¯æ¡ç®€çŸ­è¯´æ˜ï¼‰
4. çŸ­æœŸï¼ˆ1â€“4å‘¨ï¼‰å¤§æ¦‚ç‡èµ°åŠ¿é¢„æœŸ
5. ä¸­æœŸï¼ˆ1â€“3ä¸ªæœˆï¼‰å¤§æ¦‚ç‡èµ°åŠ¿é¢„æœŸ
6. ç»™æ™®é€šæ•£æˆ·çš„ä¿å®ˆæ“ä½œå»ºè®®ï¼ˆå¼ºçƒˆå»ºè®®å…¥æ‰‹ / å»ºè®®åˆ†æ‰¹å…¥æ‰‹ / è§‚æœ› / å»ºè®®å‡æŒ / å¼ºçƒˆå»ºè®®å‡æŒ ç­‰ï¼‰ï¼Œå¹¶ç®€è¦è¯´æ˜ç†ç”±

è¯­æ°”è¦æ±‚ï¼šç†æ€§ã€è°¨æ…ã€å®¢è§‚ï¼Œé¿å…ä»»ä½•ç»å¯¹åŒ–è¯­è¨€æˆ–æ”¶ç›Šä¿è¯ã€‚
"""

# ç¤ºä¾‹æ–°é—»æ•°æ®ï¼ˆå®é™…ç”Ÿäº§å»ºè®®æ¥å…¥ akshare.stock_news_em() æˆ–å…¶ä»–æ–°é—»æ¥å£ï¼‰
news_examples = {
    "600519": {
        "name": "è´µå·èŒ…å°",
        "industry": "ç™½é…’",
        "news_summary": """\
1. ièŒ…å°æŒç»­ç«çˆ†ï¼Œ1499å…ƒé£å¤©å‡ ä¹æ¯å¤©ç§’ç©ºï¼ŒçœŸå®æ¶ˆè´¹éœ€æ±‚å¼ºåŠ²
2. 2026å¹´å¸‚åœºåŒ–è¿è¥æ–¹æ¡ˆé€šè¿‡ï¼Œå»ºç«‹å¤šå…ƒæ¸ é“+åŠ¨æ€ä»·æ ¼æœºåˆ¶
3. éƒ¨åˆ†éæ ‡äº§å“å‡ºå‚ä»·å¤§å¹…ä¸‹è°ƒï¼Œæ¸ é“çŸ­æœŸåˆ©æ¶¦æ‰¿å‹
4. é£å¤©ç»ˆç«¯æ‰¹ä»·ä¸€åº¦è·Œç ´1499å…ƒï¼Œåº“å­˜å‹åŠ›ä»å­˜
5. å¤šå®¶åˆ¸å•†è®¤ä¸ºæ”¹é©é˜µç—›æœŸæ˜¯ä¸­é•¿æœŸå¸ƒå±€æœºä¼š"""
    },
    "300750": {
        "name": "å®å¾·æ—¶ä»£",
        "industry": "æ–°èƒ½æºç”µæ± ",
        "news_summary": """\
1. 2025å¹´å‰ä¸‰å­£åº¦å‡€åˆ©æ¶¦åŒæ¯”+36%ï¼Œä¸‰å­£åº¦å•å­£+41%
2. ä¸»åŠ›èµ„é‡‘é˜¶æ®µæ€§æµå…¥ï¼Œä½†è¿‘æœŸä¹Ÿæœ‰æ˜æ˜¾å‡€æµå‡º
3. ç¢³é…¸é”‚ç­‰åŸææ–™ä»·æ ¼éœ‡è¡ï¼Œæ¯›åˆ©ç‡é¢ä¸´å‹åŠ›
4. åŠ¨åŠ›ç”µæ± è¡Œä¸šç«äº‰æŒç»­åŠ å‰§ï¼Œä¸‹æ¸¸éœ€æ±‚é¢„æœŸåˆ†åŒ–
5. å…¬å¸æŒç»­æ¨è¿›è‚¡ä»½å›è´­è®¡åˆ’"""
    },
    # ä½ å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–çƒ­é—¨è‚¡ç¥¨...
}

# â”€â”€ æ‰§è¡Œåˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.button("å¼€å§‹ DeepSeek æ–°é—»åˆ†æ", type="primary"):
    if code not in news_examples:
        st.warning("å½“å‰æš‚æ— è¯¥è‚¡ç¥¨çš„ç¤ºä¾‹æ–°é—»æ•°æ®")
        st.info("ä½ å¯ä»¥å…ˆç”¨ 600519ï¼ˆè´µå·èŒ…å°ï¼‰æˆ– 300750ï¼ˆå®å¾·æ—¶ä»£ï¼‰æµ‹è¯•ï¼Œ\n"
                "æˆ–è‡ªè¡Œæ¥å…¥ akshare.stock_news_em() è·å–å®æ—¶æ–°é—»")
        st.stop()

    info = news_examples[code]

    prompt = prompt_template.format(
        code=code,
        name=info["name"],
        industry=info["industry"],
        news_summary=info["news_summary"],
        today=datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")
    )

    with st.spinner("DeepSeek æ­£åœ¨åˆ†æ...ï¼ˆé€šå¸¸ 5â€“20 ç§’ï¼‰"):
        try:
            response = client.chat.completions.create(
                model="deepseek-reasoner",          # æ¨è reasonerï¼Œæ›´é€‚åˆé€»è¾‘åˆ†æ
                # model="deepseek-chat",            # æˆ–è€…ç”¨ chat ç‰ˆï¼Œè¯­è¨€æ›´è‡ªç„¶
                messages=[
                    {"role": "system", "content": "ä½ æ˜¯æå…¶ä¿å®ˆã€ç†æ€§ã€è°¨æ…çš„ä¸­å›½Aè‚¡åˆ†æå¸ˆã€‚"},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.35,
                max_tokens=1400
            )

            result = response.choices[0].message.content.strip()

            st.markdown("### DeepSeek åˆ†æç»“æœ")
            st.markdown(result)

        except Exception as e:
            st.error(f"DeepSeek API è°ƒç”¨å¤±è´¥ï¼š{str(e)}")
            st.info("å¸¸è§åŸå› ï¼š\n"
                    "1. API Key é”™è¯¯æˆ–å·²è¿‡æœŸ\n"
                    "2. ä½™é¢/é¢åº¦ä¸è¶³\n"
                    "3. ç½‘ç»œè¿æ¥é—®é¢˜\n"
                    "4. æ¨¡å‹åç§°å†™é”™ï¼ˆè¯·æ£€æŸ¥æ˜¯å¦ä¸º deepseek-reasonerï¼‰")

st.markdown("---")
st.caption("æç¤ºï¼šå»ºè®®æŠŠ DEEPSEEK_API_KEY æ”¾åœ¨ Streamlit Secrets ä¸­ç®¡ç†ï¼Œé¿å…æ³„éœ²ã€‚")
st.caption("æ–°é—»å†…å®¹ç›®å‰ä¸ºç¤ºä¾‹ï¼Œç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®æ¥å…¥ akshare / tushare ç­‰æ¥å£è·å–å®æ—¶æ–°é—»ã€‚")